pipeline {
    agent any

    environment {
        DOCKER_USER = "dhinesh5799"
        DOCKER_CREDS = credentials('fdfdb2bd-8384-4bd7-bc62-bd7663e85283') // Jenkins DockerHub creds ID
        DEV_REPO = "dhinesh5799/react-app-dev"
        PROD_REPO = "dhinesh5799/react-app-prod"
        APP_SERVER = "ubuntu@3.110.138.62"
    }

    stages {

        stage('Checkout') {
            steps {
                echo "üì• Checking out source code..."
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üõ†Ô∏è Building Docker image..."
                sh 'docker build -t build-image -f ./build/Dockerfile ./build'
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "üì¶ Logging in to Docker Hub..."
                    sh "echo $DOCKER_CREDS_PSW | docker login -u $DOCKER_CREDS_USR --password-stdin"

                    if (env.BRANCH_NAME == "dev") {
                        echo "üöÄ Pushing image to DEV repo..."
                        sh "docker tag build-image $DEV_REPO:latest"
                        sh "docker push $DEV_REPO:latest"
                    }

                    if (env.BRANCH_NAME == "master") {
                        echo "üöÄ Pushing image to PROD repo..."
                        sh "docker tag build-image $PROD_REPO:latest"
                        sh "docker push $PROD_REPO:latest"
                    }
                }
            }
        }

        stage('Deploy to Application Server') {
            when { branch 'master' }
            steps {
                echo "üöÄ Deploying to EC2 server..."
                sshagent(['app-server']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no $APP_SERVER '
                            echo "üîë Logging into Docker Hub..."
                            echo $DOCKER_CREDS_PSW | docker login -u $DOCKER_CREDS_USR --password-stdin
                            echo "üßπ Cleaning up old containers..."
                            docker stop react-app || true
                            docker rm react-app || true
                            docker pull $PROD_REPO:latest
                            echo "üöÄ Running new container..."
                            docker run -d -p 80:80 --name react-app $PROD_REPO:latest
                            echo "‚úÖ Deployment successful!"
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline completed successfully for branch: ${env.BRANCH_NAME}"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
